generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(uuid())
  email           String         @unique
  password        String
  name            String
  firstName       String?
  lastName        String?
  phone           String?
  status          UserStatus     @default(ACTIVE)
  isSystemAdmin   Boolean        @default(false)  // Super admin systemowy
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  unitMemberships UserUnit[]
  roleAssignments UserRole[]
  conversations   Conversation[]
}

// Role - grupy uprawnień (elastyczne, definiowane przez użytkownika)
model Role {
  id          String           @id @default(uuid())
  unitId      String?          // null = rola systemowa, inaczej rola dla konkretnej jednostki
  name        String
  code        String           // np. ADMIN, KSIEGOWY, SKARBNIK - unikalny kod
  description String?
  isSystem    Boolean          @default(false) // role systemowe nie mogą być usuwane
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  unit        BudgetUnit?      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  userRoles   UserRole[]

  @@unique([unitId, code])
  @@index([unitId])
}

// Uprawnienia - granularne, np. "accounts.create", "operations.approve"
model Permission {
  id          String           @id @default(uuid())
  code        String           @unique // np. "accounts.create", "accounts.delete"
  name        String           // Czytelna nazwa, np. "Tworzenie kont"
  module      String           // Moduł: accounts, operations, reports, users, settings
  description String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]
}

// Powiązanie Rola <-> Uprawnienie
model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// Powiązanie Użytkownik <-> Rola (w kontekście jednostki, dziennika, okresu)
model UserRole {
  id             String        @id @default(uuid())
  userId         String
  roleId         String
  unitId         String        // wymagane - do której jednostki
  journalId      String?       // null = wszystkie dzienniki, inaczej tylko ten dziennik
  fiscalPeriodId String?       // null = wszystkie okresy, inaczej tylko ten okres
  createdAt      DateTime      @default(now())
  role           Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  unit           BudgetUnit    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  journal        Journal?      @relation(fields: [journalId], references: [id], onDelete: Cascade)
  fiscalPeriod   FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, unitId, journalId, fiscalPeriodId])
  @@index([userId])
  @@index([roleId])
  @@index([unitId])
  @@index([journalId])
  @@index([fiscalPeriodId])
}

model UserUnit {
  id        String       @id @default(uuid())
  userId    String
  unitId    String
  role      UserUnitRole @default(MEMBER)
  isOwner   Boolean      @default(false)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  unit      BudgetUnit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId])
  @@index([userId])
  @@index([unitId])
}

model BudgetUnit {
  id                    String                 @id @default(uuid())
  name                  String
  shortName             String?
  regon                 String?
  nip                   String?
  unitType              UnitType               @default(JEDNOSTKA_BUDZETOWA)
  defaultDzial          String?
  defaultRozdzial       String?
  fiscalYearStart       Int                    @default(1)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  accounts              Account[]
  budgetClassifications BudgetClassification[]
  financialPlans        FinancialPlan[]
  fiscalPeriods         FiscalPeriod[]
  journals              Journal[]
  operations            Operation[]
  reports               Report[]
  userMemberships       UserUnit[]
  roles                 Role[]
  userRoles             UserRole[]
  conversations         Conversation[]
}

model FiscalPeriod {
  id          String     @id @default(uuid())
  unitId      String
  name        String                          // np. "Rok 2024", "2024/2025"
  startDate   DateTime
  endDate     DateTime
  isClosed    Boolean    @default(false)      // Czy okres jest zamknięty
  isActive    Boolean    @default(false)      // Czy jest aktywnym okresem (tylko jeden na jednostkę)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  unit        BudgetUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  accounts    Account[]
  operations  Operation[]
  userRoles   UserRole[]

  @@unique([unitId, name])
  @@index([unitId, isActive])
}

model Journal {
  id                     String                 @id @default(uuid())
  unitId                 String
  name                   String
  shortName              String
  type                   JournalType            @default(BUDZET)
  description            String?
  requiresClassification Boolean                @default(true)
  hasOwnAccountPlan      Boolean                @default(true)
  hasFinancialPlan       Boolean                @default(true)
  isDefault              Boolean                @default(false)
  isActive               Boolean                @default(true)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  accounts               Account[]
  budgetClassifications  BudgetClassification[]
  unit                   BudgetUnit             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  operations             Operation[]
  userRoles              UserRole[]

  @@unique([unitId, shortName])
  @@index([unitId, isActive])
}

model Account {
  id                      String         @id @default(uuid())
  unitId                  String
  journalId               String
  fiscalPeriodId          String?                              // Powiązanie z okresem obrachunkowym
  number                  String
  name                    String
  zespol                  Int
  syntetyczne             String
  analitpierwsze          String?
  analitdrugie            String?
  accountType             AccountType
  normalBalance           BalanceSide
  isActive                Boolean        @default(true)
  description             String?
  parentId                String?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  fiscalPeriod            FiscalPeriod?  @relation(fields: [fiscalPeriodId], references: [id])
  journal                 Journal        @relation(fields: [journalId], references: [id], onDelete: Cascade)
  parent                  Account?       @relation("AccountHierarchy", fields: [parentId], references: [id])
  children                Account[]      @relation("AccountHierarchy")
  unit                    BudgetUnit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  creditEntries           JournalEntry[] @relation("CreditAccount")
  debitEntries            JournalEntry[] @relation("DebitAccount")
  offBalanceCreditEntries JournalEntry[] @relation("OffBalanceCreditAccount")
  offBalanceDebitEntries  JournalEntry[] @relation("OffBalanceDebitAccount")

  @@unique([unitId, journalId, fiscalPeriodId, number])
  @@index([unitId, zespol])
  @@index([journalId])
  @@index([fiscalPeriodId])
}

model BudgetClassification {
  id             String              @id @default(uuid())
  unitId         String
  journalId      String
  dzial          String
  rozdzial       String
  paragraf       String
  podparagraf    String?
  name           String
  type           ClassificationType
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  journal              Journal                   @relation(fields: [journalId], references: [id], onDelete: Cascade)
  unit                 BudgetUnit                @relation(fields: [unitId], references: [id], onDelete: Cascade)
  planItems            FinancialPlanItem[]
  journalEntries       JournalEntry[]
  changeRequestDetails PlanChangeRequestDetail[]

  @@unique([unitId, journalId, dzial, rozdzial, paragraf, podparagraf])
  @@index([unitId, type])
  @@index([journalId])
}

model FinancialPlan {
  id              String              @id @default(uuid())
  unitId          String
  year            Int
  version         Int                 @default(1)
  planType        PlanType            @default(PROJEKT)     // PROJEKT, PLAN_PIERWOTNY, PLAN_PO_ZMIANACH
  status          PlanStatus          @default(PROJEKT)
  name            String?                                    // Opcjonalna nazwa, np. "Plan finansowy na 2024"
  description     String?
  validFrom       DateTime?                                  // Data obowiązywania od
  validTo         DateTime?                                  // Data obowiązywania do
  approvedAt      DateTime?
  approvedBy      String?
  basedOnPlanId   String?                                    // Referencja do planu bazowego (dla zmian)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  unit            BudgetUnit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  basedOnPlan     FinancialPlan?      @relation("PlanHistory", fields: [basedOnPlanId], references: [id])
  derivedPlans    FinancialPlan[]     @relation("PlanHistory")
  items           FinancialPlanItem[]
  changeRequests  PlanChangeRequest[]
  changes         PlanChange[]

  @@unique([unitId, year, version])
  @@index([unitId, year])
  @@index([planType, status])
}

model FinancialPlanItem {
  id               String               @id @default(uuid())
  planId           String
  classificationId String
  plannedAmount    Decimal              @db.Decimal(15, 2)
  currentAmount    Decimal              @db.Decimal(15, 2)  @default(0) // Aktualna kwota po zmianach
  executedAmount   Decimal              @db.Decimal(15, 2)  @default(0) // Kwota wykonana
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  classification   BudgetClassification @relation(fields: [classificationId], references: [id])
  plan             FinancialPlan        @relation(fields: [planId], references: [id], onDelete: Cascade)
  changeDetails    PlanChangeDetail[]

  @@unique([planId, classificationId])
  @@index([planId])
  @@index([classificationId])
}

// Wniosek o zmianę planu finansowego
model PlanChangeRequest {
  id             String                    @id @default(uuid())
  planId         String
  requestNumber  String                                       // Numer wniosku, np. "ZM/2024/001"
  requestDate    DateTime                  @default(now())
  requestedBy    String?                                      // Kto składa wniosek
  reason         String                    @db.Text           // Uzasadnienie zmiany
  status         PlanChangeRequestStatus   @default(DRAFT)
  approvedAt     DateTime?
  approvedBy     String?
  rejectedAt     DateTime?
  rejectedBy     String?
  rejectionReason String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  plan           FinancialPlan             @relation(fields: [planId], references: [id], onDelete: Cascade)
  details        PlanChangeRequestDetail[]
  change         PlanChange?                                  // Po zatwierdzeniu tworzony jest rekord zmiany

  @@index([planId])
  @@index([status])
}

// Szczegóły wniosku o zmianę (pozycje do zmiany)
model PlanChangeRequestDetail {
  id                 String               @id @default(uuid())
  requestId          String
  classificationId   String
  currentAmount      Decimal              @db.Decimal(15, 2)  // Kwota przed zmianą
  requestedAmount    Decimal              @db.Decimal(15, 2)  // Wnioskowana kwota
  changeAmount       Decimal              @db.Decimal(15, 2)  // Różnica (może być ujemna)
  justification      String?                                   // Uzasadnienie dla tej pozycji
  createdAt          DateTime             @default(now())
  request            PlanChangeRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  classification     BudgetClassification @relation(fields: [classificationId], references: [id])

  @@unique([requestId, classificationId])
  @@index([requestId])
}

// Zatwierdzona zmiana planu
model PlanChange {
  id               String              @id @default(uuid())
  planId           String
  requestId        String?             @unique              // Powiązanie z wnioskiem (opcjonalne - zmiana może być bez wniosku)
  changeNumber     String                                   // Numer zmiany, np. "ZM/2024/001"
  changeDate       DateTime            @default(now())
  changeType       PlanChangeType      @default(ZMIANA)     // ZMIANA, KOREKTA, PRZENIESIENIE
  description      String?
  approvedBy       String?
  legalBasis       String?                                  // Podstawa prawna zmiany
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  plan             FinancialPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  request          PlanChangeRequest?  @relation(fields: [requestId], references: [id])
  details          PlanChangeDetail[]

  @@index([planId])
  @@index([changeDate])
}

// Szczegóły zmiany planu (które pozycje się zmieniły)
model PlanChangeDetail {
  id               String               @id @default(uuid())
  changeId         String
  planItemId       String
  previousAmount   Decimal              @db.Decimal(15, 2)  // Kwota przed zmianą
  newAmount        Decimal              @db.Decimal(15, 2)  // Kwota po zmianie
  changeAmount     Decimal              @db.Decimal(15, 2)  // Różnica
  createdAt        DateTime             @default(now())
  change           PlanChange           @relation(fields: [changeId], references: [id], onDelete: Cascade)
  planItem         FinancialPlanItem    @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([changeId])
  @@index([planItemId])
}

model Operation {
  id              String          @id @default(uuid())
  unitId          String
  journalId       String
  fiscalPeriodId  String?                           // Powiązanie z okresem obrachunkowym
  entryDate       DateTime        @default(now())
  bookingDate     DateTime?
  dueDate         DateTime?
  documentNumber  String
  documentType    DocumentType
  description     String
  contractorName  String?
  contractorNip   String?
  totalAmount     Decimal         @db.Decimal(15, 2)
  status          OperationStatus @default(WPROWADZONE)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  entries         JournalEntry[]
  fiscalPeriod    FiscalPeriod?   @relation(fields: [fiscalPeriodId], references: [id])
  journal         Journal         @relation(fields: [journalId], references: [id])
  unit            BudgetUnit      @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([fiscalPeriodId])
}

model JournalEntry {
  id                        String                @id @default(uuid())
  operationId               String
  debitAccountId            String?               // Opcjonalne - dla BO może być tylko Wn lub tylko Ma
  creditAccountId           String?               // Opcjonalne - dla BO może być tylko Wn lub tylko Ma
  amount                    Decimal               @db.Decimal(15, 2)
  offBalanceDebitAccountId  String?
  offBalanceCreditAccountId String?
  classificationId          String?
  description               String?
  journalNumber             Int?
  createdAt                 DateTime              @default(now())
  classification            BudgetClassification? @relation(fields: [classificationId], references: [id])
  creditAccount             Account?              @relation("CreditAccount", fields: [creditAccountId], references: [id])
  debitAccount              Account?              @relation("DebitAccount", fields: [debitAccountId], references: [id])
  offBalanceCreditAccount   Account?              @relation("OffBalanceCreditAccount", fields: [offBalanceCreditAccountId], references: [id])
  offBalanceDebitAccount    Account?              @relation("OffBalanceDebitAccount", fields: [offBalanceDebitAccountId], references: [id])
  operation                 Operation             @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([operationId])
  @@index([debitAccountId])
  @@index([creditAccountId])
}

model Report {
  id          String     @id @default(uuid())
  unitId      String
  type        ReportType
  periodStart DateTime
  periodEnd   DateTime
  data        Json
  generatedAt DateTime   @default(now())
  unit        BudgetUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId, type])
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
}

enum UserUnitRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UnitType {
  JEDNOSTKA_BUDZETOWA
  ZAKLAD_BUDZETOWY
  ORGAN_BUDZETU
}

enum JournalType {
  BUDZET
  WRD
  ZFSS
  INNY
}

enum AccountType {
  BILANSOWE_AKTYWNE
  BILANSOWE_PASYWNE
  BILANSOWE_AKTYWNO_PASYWNE
  WYNIKOWE_KOSZTOWE
  WYNIKOWE_PRZYCHODOWE
  POZABILANSOWE
  ROZLICZENIOWE
}

enum BalanceSide {
  DEBIT
  CREDIT
}

enum ClassificationType {
  DOCHOD
  WYDATEK
  PRZYCHOD
  ROZCHOD
}

enum PlanStatus {
  PROJEKT               // Wersja robocza
  ZATWIERDZONY          // Plan zatwierdzony
  ARCHIWALNY            // Poprzednia wersja planu (po wprowadzeniu zmian)
}

enum PlanType {
  PROJEKT               // Projekt planu (przed zatwierdzeniem)
  PLAN_PIERWOTNY        // Plan pierwotny (uchwalony)
  PLAN_PO_ZMIANACH      // Plan po wprowadzeniu zmian
}

enum PlanChangeRequestStatus {
  DRAFT                 // Wersja robocza wniosku
  SUBMITTED             // Wniosek złożony
  IN_REVIEW             // W trakcie rozpatrywania
  APPROVED              // Zatwierdzony
  REJECTED              // Odrzucony
  CANCELLED             // Anulowany
}

enum PlanChangeType {
  ZMIANA                // Standardowa zmiana planu (uchwała)
  KOREKTA               // Korekta techniczna
  PRZENIESIENIE         // Przeniesienie środków między paragrafami
}

enum DocumentType {
  FAKTURA_ZAKUP
  FAKTURA_SPRZEDAZ
  WYCIAG_BANKOWY
  RAPORT_KASOWY
  LISTA_PLAC
  PK
  NOTA_KSIEGOWA
  OT
  LT
  INNE
  BO
}

enum OperationStatus {
  WPROWADZONE
  ZADEKRETOWANE
  ZAKSIEGOWANE
  ANULOWANE
}

enum ReportType {
  BILANS
  RZIS
  ZESTAWIENIE_ZMIAN_FUNDUSZU
  ZESTAWIENIE_OBROTOW_SALD
  RB_27S
  RB_28S
  RB_34S
  RB_N
  RB_Z
}

// =====================
// AI Chat - Asystent księgowy
// =====================

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  unitId    String?   // Opcjonalny kontekst jednostki budżetowej
  title     String    // Tytuł rozmowy (generowany z pierwszego pytania)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit      BudgetUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)
  messages  Message[]

  @@index([userId])
  @@index([unitId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  role           MessageRole  // USER lub ASSISTANT
  content        String       @db.Text
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

enum MessageRole {
  USER
  ASSISTANT
}
